---
layout:     post
title:      一个简单协程设计
subtitle:   协程
date:       2020-01-31
author:     BY ZYZ
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - C/C++
    - 协程
---

# 协程
## 定义
协程（英语：coroutine）是计算机程序的一类组件，推广了协作式多任务的子程序，允许执行被挂起与被恢复。相对子例程而言，协程更为一般和灵活，但在实践中使用没有子例程那样广泛。协程更适合于用来实现彼此熟悉的程序组件，如协作式多任务、异常处理、事件循环、迭代器、无限列表和管道。
## 与线程区别
协程非常类似于线程。但是协程是协作式多任务的，而线程典型是抢占式多任务的。这意味着协程提供并发性而非并行性。协程超过线程的好处是它们可以用于硬性实时的语境（在协程之间的切换不需要涉及任何**系统调用**或任何**阻塞调用**），这里不需要用来守卫关键区块的同步性原语（primitive）比如互斥锁、信号量等，并且不需要来自操作系统的支持。有可能以一种对调用代码透明的方式，使用抢占式调度的线程实现协程，但是会失去某些利益（特别是对硬性实时操作的适合性和相对廉价的相互之间切换）。

协程是协作式多任务的轻量级线程，本质上描述了同协程一样的概念。其区别，如果一定要说有的话，是协程是语言层级的构造，可看作一种形式的控制流，而协程是系统层级的构造，可看作恰巧没有并行运行的线程。这两个概念谁有优先权是争议性的：协程可看作为协程的一种实现，也可看作实现协程的基底。

[详见WIKI](https://zh.wikipedia.org/wiki/%E5%8D%8F%E7%A8%8B)

## 几种著名的C/C++协程库
### [libco](https://github.com/Tencent/libco) 
腾讯出品，是微信后台大规模使用的c/c++协程库，2013年至今稳定运行在微信后台的数万台机器上。libco通过仅有的几个函数接口 co_create/co_resume/co_yield 再配合 co_poll，可以支持同步或者异步的写法，如线程库一样轻松。同时库里面提供了socket族函数的hook，使得后台逻辑服务几乎不用修改逻辑代码就可以完成异步化改造。
### [libgo](https://github.com/yyzybb537/libgo) 
魅族团队开发，libgo是一个跨平台的stackful协程库，用C++11编写，在并行编程应用中很牛逼且容易使用。该库使用起来如同go语言的协程一般。
 1. go风格
 2. 支持大量协程，1M个协程仅消耗4.5G内存
 3. 支持多线程调度协议，提供有效的负载均衡策略与同步机制
 4. 调度线程数量可伸缩
 5. 使用hook技术，让第三方库的同步调用变为异步调用
   
   ...
### boost.coroutine2/boost.context/boost.corutine等boost的协程库

## 一个简单协程设计的几个要点
### 协程状态
协程一般有以下几个状态：
  + REDY 协程起始状态
  + RUNNING 当前协程运行状态，一般为起始状态切入或者由挂起状态切回
  + SUSPEND 协程挂起状态，一般由RUNNING状态切入
  + DEAD 协程死亡状态，协程任务运行完毕
  
  ![协程状态机](/img/co_state.jpg)

### 协程调度器设计
  简单点设计，当任务启动后，保存调度器当前上下文，运行任务，当任务挂起时，再保存当前任务的上下文，并恢复调度器的上下文。至于选取哪个任务运行，由调度器的调度算法决定。可以参考线程调度策略，可以公平的轮转选取，也可以生成一个随机数，并根据随机数选取需要执行的任务。协程调度器的调度如下图所示。
  ![协程调度器任务切换](/img/sheduler.jpg)

### 推荐一个C语言实现的协程库
  [云风-coroutine](https://github.com/cloudwu/coroutine)
  这是云风大神用C语言实现的协程库，基本思想就是上述所说。
  [云风-coroutine源码解析](https://www.jianshu.com/p/c4c1af5a20d9)这篇文章很好的剖析了云风协程库的设计，包括最重要的上下文如何切换，以及栈在stackful协程中如何保存。看懂了这篇文章，协程基本就入门了。
